name: pr-checks

on:
  pull_request:
    branches: [main]

concurrency:
  group: pr-checks-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  checks:
    runs-on: [self-hosted]
    if: github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - uses: actions/checkout@v4

      - name: Set vars
        run: |
          echo "COMPOSE_PROJECT_NAME=pr-${{ github.event.pull_request.number }}-${{ github.run_id }}" >> $GITHUB_ENV
          echo "HOST_UID=$(id -u)" >> $GITHUB_ENV
          echo "HOST_GID=$(id -g)" >> $GITHUB_ENV

      - name: Start testing stack
        run: |
          docker compose \
            -p "$COMPOSE_PROJECT_NAME" \
            -f docker-compose.testing.yml \
            up -d --remove-orphans

      - name: Install deps + static checks
        run: |
          docker compose -p "$COMPOSE_PROJECT_NAME" exec -T app bash -lc '
            set -euo pipefail
            composer install --prefer-dist --no-interaction
            composer lint
            composer analyse
            composer rector-dry
          '

      - name: DB + tests
        run: |
          docker compose -p "$COMPOSE_PROJECT_NAME" exec -T app bash -lc '
            set -euo pipefail
            cp -f .env.testing .env
            php artisan optimize:clear
            php artisan migrate:fresh --seed --env=testing
            php artisan test --env=testing
          '

      - name: Cleanup
        if: always()
        run: |
          docker compose -p "$COMPOSE_PROJECT_NAME" -f docker-compose.testing.yml down -v --remove-orphans
